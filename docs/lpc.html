<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>LoRa Pulse Counter Demo | Cameron Harper</title>
<meta name="generator" content="Jekyll v3.7.3" />
<meta property="og:title" content="LoRa Pulse Counter Demo" />
<meta name="author" content="Cameron Harper" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="Cameron Harper" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-05T00:00:00+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"LoRa Pulse Counter Demo","dateModified":"2019-02-05T00:00:00+00:00","datePublished":"2019-02-05T00:00:00+00:00","url":"/lpc","mainEntityOfPage":{"@type":"WebPage","@id":"/lpc"},"author":{"@type":"Person","name":"Cameron Harper"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Cameron Harper" />
  
    <script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-39608896-1', 'auto');
  ga('send', 'pageview');
}
</script>
  

  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" rel="author" href="/">Cameron Harper</a>

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">LoRa Pulse Counter Demo</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-02-05T00:00:00+00:00" itemprop="datePublished">
        
        Feb 5, 2019
      </time>
      </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#application">Application</a></li>
<li class="toc-entry toc-h2"><a href="#features">Features</a>
<ul>
<li class="toc-entry toc-h3"><a href="#lorawan">LoRaWAN</a></li>
<li class="toc-entry toc-h3"><a href="#digital-inputs">Digital Inputs</a></li>
<li class="toc-entry toc-h3"><a href="#external-pickup-power-supply">External Pickup Power Supply</a></li>
<li class="toc-entry toc-h3"><a href="#status-button-and-led">Status Button and LED</a></li>
<li class="toc-entry toc-h3"><a href="#uart-connection">UART Connection</a></li>
<li class="toc-entry toc-h3"><a href="#battery-voltage-sensor">Battery Voltage Sensor</a></li>
<li class="toc-entry toc-h3"><a href="#ambient-temperature-sensor">Ambient Temperature Sensor</a></li>
<li class="toc-entry toc-h3"><a href="#field-serviceable-primary-cell">Field Serviceable Primary Cell</a></li>
<li class="toc-entry toc-h3"><a href="#low-power-design">Low Power Design</a></li>
<li class="toc-entry toc-h3"><a href="#configurable">Configurable</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#lorawan-message-format">LoRaWAN Message Format</a>
<ul>
<li class="toc-entry toc-h3"><a href="#device-to-application">Device-to-Application</a>
<ul>
<li class="toc-entry toc-h4"><a href="#one-counter1-port-1">One-Counter1 (port 1)</a></li>
<li class="toc-entry toc-h4"><a href="#two-counters-port-1">Two-Counters (port 1)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#uart-communication-protocol">UART Communication Protocol</a>
<ul>
<li class="toc-entry toc-h3"><a href="#uart-settings">UART Settings</a></li>
<li class="toc-entry toc-h3"><a href="#framing">Framing</a></li>
<li class="toc-entry toc-h3"><a href="#commands">Commands</a>
<ul>
<li class="toc-entry toc-h4"><a href="#set-dev-eui">Set-Dev-EUI</a></li>
<li class="toc-entry toc-h4"><a href="#set-app-eui">Set-App-EUI</a></li>
<li class="toc-entry toc-h4"><a href="#set-app-key">Set-App-Key</a></li>
<li class="toc-entry toc-h4"><a href="#get-dev-eui">Get-Dev-EUI</a></li>
<li class="toc-entry toc-h4"><a href="#get-app-eui">Get-App-EUI</a></li>
<li class="toc-entry toc-h4"><a href="#get-encrypted-app-key">Get-Encrypted-App-Key</a></li>
<li class="toc-entry toc-h4"><a href="#join-network">Join-Network</a></li>
<li class="toc-entry toc-h4"><a href="#forget-network">Forget-Network</a></li>
<li class="toc-entry toc-h4"><a href="#set-log-severity-level">Set-Log-Severity-Level</a></li>
<li class="toc-entry toc-h4"><a href="#get-vbat-and-ambient">Get-VBAT-And-Ambient</a></li>
<li class="toc-entry toc-h4"><a href="#get-counter">Get-Counter</a></li>
<li class="toc-entry toc-h4"><a href="#clear-counter">Clear-Counter</a></li>
<li class="toc-entry toc-h4"><a href="#set-pull">Set-Pull</a></li>
<li class="toc-entry toc-h4"><a href="#set-filter">Set-Filter</a></li>
<li class="toc-entry toc-h4"><a href="#goto-boot">Goto-Boot</a></li>
<li class="toc-entry toc-h4"><a href="#goto-app">Goto-App</a></li>
<li class="toc-entry toc-h4"><a href="#boot-or-app">Boot-Or-App</a></li>
<li class="toc-entry toc-h4"><a href="#get-boot-version">Get-Boot-Version</a></li>
<li class="toc-entry toc-h4"><a href="#get-app-version">Get-App-Version</a></li>
<li class="toc-entry toc-h4"><a href="#restart">Restart</a></li>
<li class="toc-entry toc-h4"><a href="#get-device-name">Get-Device-Name</a></li>
<li class="toc-entry toc-h4"><a href="#set-device-name">Set-Device-Name</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#alerts">Alerts</a>
<ul>
<li class="toc-entry toc-h4"><a href="#unknown-message">Unknown-Message</a></li>
<li class="toc-entry toc-h4"><a href="#unknown-command">Unknown-Command</a></li>
<li class="toc-entry toc-h4"><a href="#invalid-command-argument">Invalid-Command-Argument</a></li>
<li class="toc-entry toc-h4"><a href="#log">Log</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#hardware-revisions">Hardware Revisions</a>
<ul>
<li class="toc-entry toc-h3"><a href="#040">0.4.0</a></li>
<li class="toc-entry toc-h3"><a href="#020">0.2.0</a></li>
<li class="toc-entry toc-h3"><a href="#011">0.1.1</a></li>
</ul>
</li>
</ul><p><img src="/assets/lpc_0.2.0.jpg" alt="assembled board" class="center-image"></p>

<p>Above is version <a href="#020">0.4.0</a> of the LoRa Pulse Counter demonstration platform.</p>

<p>This project exists to demonstrate an end-to-end hardware/firmware/software project. It was
also an opportunity to evaluate <a href="http://kicad-pcb.org/">Kicad</a>.</p>

<h2 id="application">
<a id="application" class="anchor" href="#application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Application</h2>

<p>The device can be used to count electrical pulses produced by 
instruments and/or detect level changes from switch based sensors. 
The count and level state is sent to a remote application over LoRaWAN.</p>

<p>This might seem dull but it is useful for things like:</p>

<ul>
  <li>retrofitting remote reading to existing electricity and water meters</li>
  <li>tamper detection (e.g. someone opened a door)</li>
  <li>storage tank level monitoring (e.g. float switches)</li>
  <li>interactive demonstrations</li>
</ul>

<h2 id="features">
<a id="features" class="anchor" href="#features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Features</h2>

<h3 id="lorawan">
<a id="lorawan" class="anchor" href="#lorawan" aria-hidden="true"><span class="octicon octicon-link"></span></a>LoRaWAN</h3>

<p>The device uses LoRaWAN to send data to a remote application. 
The stack makes use of over-the-air-activation (OTAA)
and adapative data rate (ADR) to keep setup and operation of the device
as simple as possible.</p>

<p>The implementation used in this project is bespoke and not based
on any of the existing permissively licensed projects.
You can have a peek at the API documentation <a href="https://cjhdev.github.io/lora_device_lib_api/">here</a>.</p>

<h3 id="digital-inputs">
<a id="digital-inputs" class="anchor" href="#digital-inputs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Digital Inputs</h3>

<p>The device has four inputs suitable for interfacing with open-collector, 
dry-contact, or push-pull outputs. In the case of push-pull, the voltage applied
must not exceed the battery voltage, which can be referenced from the “V+” terminals.</p>

<p>All inputs implement the same circuit:</p>

<p>«circuit»</p>

<p>Rise-time of the active signal is limited to 250us the RC filter. The fall-time
will be around 500us for open-collector outputs.</p>

<p>The rise-time can be further limited by a configurable software filter. This allows
each input to be adapted to different types of outputs (e.g. slow bouncy contacts vs. fast digital switches).</p>

<p>Each input has a configurable pull up/down resistor. This is useful
for adapting the average energy consumption to the resting state of the input
signal.</p>

<h3 id="external-pickup-power-supply">
<a id="external-pickup-power-supply" class="anchor" href="#external-pickup-power-supply" aria-hidden="true"><span class="octicon octicon-link"></span></a>External Pickup Power Supply</h3>

<p>The device can supply a small amount of power to external sensors through
the “V+” terminals.</p>

<p>You may, for example, need to power a photodiode detector circuit in order
to detect a flashing LED.</p>

<h3 id="status-button-and-led">
<a id="status-button-and-led" class="anchor" href="#status-button-and-led" aria-hidden="true"><span class="octicon octicon-link"></span></a>Status Button and LED</h3>

<p>The device has a button which when pressed enables a status LED which
makes it possible to quickly inspect the status of the device.</p>

<p>The status codes are as follows:</p>

<table>
  <thead>
    <tr>
      <th>number of flashes</th>
      <th>status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>dead</td>
    </tr>
    <tr>
      <td>1</td>
      <td>joined and downlink received in interval</td>
    </tr>
    <tr>
      <td>2</td>
      <td>joined but no downlink received in interval</td>
    </tr>
    <tr>
      <td>3</td>
      <td>joining</td>
    </tr>
    <tr>
      <td>4</td>
      <td>not-joined</td>
    </tr>
  </tbody>
</table>

<h3 id="uart-connection">
<a id="uart-connection" class="anchor" href="#uart-connection" aria-hidden="true"><span class="octicon octicon-link"></span></a>UART Connection</h3>

<p>The device has a level-converted UART connection for the purpose of
performing configuration and applying updates. The level converter
is implemented in such a way that it doesn’t consume any energy from
the battery.</p>

<p>The connector pin assignment is as follows:</p>

<table>
  <thead>
    <tr>
      <th>pin</th>
      <th>signal</th>
      <th>comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>GND</td>
      <td>mandatory</td>
    </tr>
    <tr>
      <td>2</td>
      <td>CTS</td>
      <td>connected to GND</td>
    </tr>
    <tr>
      <td>3</td>
      <td>VCC</td>
      <td>mandatory 3V3 or 5V (this powers the level converter)</td>
    </tr>
    <tr>
      <td>4</td>
      <td>TXD</td>
      <td>transmit line</td>
    </tr>
    <tr>
      <td>5</td>
      <td>RXD</td>
      <td>receive line</td>
    </tr>
    <tr>
      <td>6</td>
      <td>DTR</td>
      <td>not connected</td>
    </tr>
  </tbody>
</table>

<p>This connector is compatible with USB-to-serial converters
made by FTDI, Sparkfun, and many others.</p>

<p>The <a href="#uart-communication-protocol">UART Communication Protocol</a> runs
over this connection.</p>

<h3 id="battery-voltage-sensor">
<a id="battery-voltage-sensor" class="anchor" href="#battery-voltage-sensor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Battery Voltage Sensor</h3>

<p>The device is able to sample battery voltage. This information is made
available to the remote application.</p>

<h3 id="ambient-temperature-sensor">
<a id="ambient-temperature-sensor" class="anchor" href="#ambient-temperature-sensor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Ambient Temperature Sensor</h3>

<p>The device is able to sample ambient temperature. This information is made available to 
the remote application.</p>

<h3 id="field-serviceable-primary-cell">
<a id="field-serviceable-primary-cell" class="anchor" href="#field-serviceable-primary-cell" aria-hidden="true"><span class="octicon octicon-link"></span></a>Field Serviceable Primary Cell</h3>

<p>The device is powered by a CR123A (Li-MnO2) primary cell which
is installed in a PCB mounted holder.</p>

<p>The hardware includes reverse polarity protection just in case the cell is
installed backwards.</p>

<h3 id="low-power-design">
<a id="low-power-design" class="anchor" href="#low-power-design" aria-hidden="true"><span class="octicon octicon-link"></span></a>Low Power Design</h3>

<p>Power consumption (and battery life) depends on three things: hardware implementation,
firmware implementation, and application requirements.</p>

<p>The hardware is designed to produce the lowest possible power consumption during active
and sleep modes. To achieve this the following decisions were made:</p>

<ul>
  <li>direct unregulated power supply</li>
  <li>UART level converter is powered by</li>
  <li>status LED is active only when the user requests it via the user button</li>
  <li>STM32L051 MCU (using LSE + HSI oscillators)</li>
  <li>4MHz system clock (HSI/4)</li>
</ul>

<p>The firmware implementation is event driven and takes advantage of the MCU “wake from stop mode”
features. The MCU will wake from:</p>

<ul>
  <li>external interrupts</li>
  <li>LPTIM backed application timer</li>
  <li>UART start bit</li>
</ul>

<p>Average power consumption then depends on the demands of the application:</p>

<ul>
  <li>resting state of digital inputs (vs. the pull up/down configuration)</li>
  <li>frequency of pulse signals</li>
  <li>frequency of pulse count reporting (configurable)</li>
  <li>alerting strategy (configurable)</li>
  <li>link-check strategy (configurable)</li>
</ul>

<h3 id="configurable">
<a id="configurable" class="anchor" href="#configurable" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configurable</h3>

<p>While incomplete at this stage, the following characteristics are 
intended to be configurable:</p>

<ul>
  <li>input filter mode</li>
  <li>input trigger mode
    <ul>
      <li>rising</li>
      <li>falling</li>
      <li>both</li>
    </ul>
  </li>
  <li>input pullup/pulldown mode</li>
  <li>alert mode
    <ul>
      <li>active high/low</li>
    </ul>
  </li>
  <li>message formats
    <ul>
      <li>two counters</li>
      <li>one counter per message</li>
      <li>counter(s) plus alert status field</li>
    </ul>
  </li>
  <li>counter push interval</li>
  <li>alert notification strategy</li>
</ul>

<h2 id="lorawan-message-format">
<a id="lorawan-message-format" class="anchor" href="#lorawan-message-format" aria-hidden="true"><span class="octicon octicon-link"></span></a>LoRaWAN Message Format</h2>

<p>LoRaWAN messages are differentiated by port number.</p>

<h3 id="device-to-application">
<a id="device-to-application" class="anchor" href="#device-to-application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Device-to-Application</h3>

<p><a href="https://www.itu.int/rec/T-REC-X.696/en">Octet Encoding Rules X.696</a></p>

<h4 id="one-counter1-port-1">
<a id="one-counter1-port-1" class="anchor" href="#one-counter1-port-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>One-Counter1 (port 1)</h4>

<h4 id="two-counters-port-1">
<a id="two-counters-port-1" class="anchor" href="#two-counters-port-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Two-Counters (port 1)</h4>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Two-Counters ::= SEQUENCE
{
    channel1    INTEGER (0..max-uint32),
    channel2    INTEGER (0..max-uint32)
    channel3    INTEGER (0..max-uint32)
    channel4    INTEGER (0..max-uint32)
}

max-uint32 Integer ::= 4294967295</code></pre></figure>

<h2 id="uart-communication-protocol">
<a id="uart-communication-protocol" class="anchor" href="#uart-communication-protocol" aria-hidden="true"><span class="octicon octicon-link"></span></a>UART Communication Protocol</h2>

<p>The following protocol allows the device to managed over the UART connection.</p>

<h3 id="uart-settings">
<a id="uart-settings" class="anchor" href="#uart-settings" aria-hidden="true"><span class="octicon octicon-link"></span></a>UART Settings</h3>

<ul>
  <li>38400 baud</li>
  <li>8 data bits, 1 stop bit, no parity</li>
</ul>

<h3 id="framing">
<a id="framing" class="anchor" href="#framing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Framing</h3>

<p>The protocol uses start, end, escape, and xor characters to mark start/end of 
messages and to remove start/end markers from the message payload.</p>

<p>Special characters are as follows:</p>

<table>
  <thead>
    <tr>
      <th>name</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>start</td>
      <td>0x7e</td>
    </tr>
    <tr>
      <td>end</td>
      <td>0x7f</td>
    </tr>
    <tr>
      <td>escape</td>
      <td>0x7d</td>
    </tr>
    <tr>
      <td>xor</td>
      <td>0x20</td>
    </tr>
  </tbody>
</table>

<p>When a start, end, or escape character appears within a message payload, it is replaced
by an escape character followed by the original character XORed with the xor character.</p>

<p>The last two bytes of a frame is a 16 bit CRC ordered most significant byte first.
The CRC is calculated over the payload bytes prior to any escaping.</p>

<p>CRC parameters are as follows:</p>

<table>
  <tbody>
    <tr>
      <td>name</td>
      <td>CRC-16-CCITT</td>
    </tr>
    <tr>
      <td>polynomial</td>
      <td>0x1021</td>
    </tr>
    <tr>
      <td>initial value</td>
      <td>0xffff</td>
    </tr>
    <tr>
      <td>reflect input</td>
      <td>no</td>
    </tr>
    <tr>
      <td>reflect output</td>
      <td>no</td>
    </tr>
    <tr>
      <td>xor output</td>
      <td>no</td>
    </tr>
  </tbody>
</table>

<h3 id="commands">
<a id="commands" class="anchor" href="#commands" aria-hidden="true"><span class="octicon octicon-link"></span></a>Commands</h3>

<p>Commands are constructed as a sequence of a Command-Header
followed by a command specific argument. Similarly Responses
are constructed as a sequence of a Command-Header followed by
a response specific Argument.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Header ::= [0] SEQUENCE 
{
    token   INTEGER (0..255),
    c-id    INTEGER (0..65535)
}

Response-Header ::= [1] SEQUENCE 
{
    token   INTEGER (0..255),
    c-id    INTEGER (0..65535)
}</code></pre></figure>

<table>
  <thead>
    <tr>
      <th>c-id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td><a href="#boot-or-app">Boot-Or-App</a></td>
    </tr>
    <tr>
      <td>0x0001</td>
      <td><a href="#goto-boot">Goto-Boot</a></td>
    </tr>
    <tr>
      <td>0x0002</td>
      <td><a href="#goto-app">Goto-App</a></td>
    </tr>
    <tr>
      <td>0x0003</td>
      <td><a href="#restart">Restart</a></td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td><a href="#get-boot-version">Get-Boot-Version</a></td>
    </tr>
    <tr>
      <td>0x0005</td>
      <td><a href="#get-app-version">Get-App-Version</a></td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td><a href="#set-dev-eui">Set-Dev-EUI</a></td>
    </tr>
    <tr>
      <td>0x0011</td>
      <td><a href="#set-app-eui">Set-App-EUI</a></td>
    </tr>
    <tr>
      <td>0x0012</td>
      <td><a href="#set-app-key">Set-App-Key</a></td>
    </tr>
    <tr>
      <td>0x0013</td>
      <td><a href="#get-dev-eui">Get-Dev-EUI</a></td>
    </tr>
    <tr>
      <td>0x0014</td>
      <td><a href="#get-app-eui">Get-App-EUI</a></td>
    </tr>
    <tr>
      <td>0x0015</td>
      <td><a href="#get-encrypted-app-key">Get-Encrypted-App-Key</a></td>
    </tr>
    <tr>
      <td>0x0016</td>
      <td><a href="#join-network">Join-Network</a></td>
    </tr>
    <tr>
      <td>0x0017</td>
      <td><a href="#forget-network">Forget-Network</a></td>
    </tr>
    <tr>
      <td>0x0018</td>
      <td><a href="#get-counter">Get-Counter</a></td>
    </tr>
    <tr>
      <td>0x0019</td>
      <td><a href="#clear-counter">Clear-Counter</a></td>
    </tr>
    <tr>
      <td>0x001a</td>
      <td><a href="#set-pull">Set-Pull</a></td>
    </tr>
    <tr>
      <td>0x001b</td>
      <td><a href="#set-filter">Set-Filter</a></td>
    </tr>
    <tr>
      <td>0x001c</td>
      <td><a href="#get-device-name">Get-Device-Name</a></td>
    </tr>
    <tr>
      <td>0x001d</td>
      <td><a href="#set-device-name">Set-Device-Name</a></td>
    </tr>
    <tr>
      <td>0x001e</td>
      <td><a href="#set-log-severity-level">Set-Log-Severity-Level</a></td>
    </tr>
    <tr>
      <td>0x001f</td>
      <td><a href="#get-vbat-and-ambient">Get-Vbat-And-Ambient</a></td>
    </tr>
  </tbody>
</table>

<p>Command/Response arguments are encoded according to <a href="https://www.itu.int/rec/T-REC-X.696/en">Octet Encoding Rules X.696</a>.</p>

<h4 id="set-dev-eui">
<a id="set-dev-eui" class="anchor" href="#set-dev-eui" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set-Dev-EUI</h4>

<p>Write Dev-EUI to non-volatile memory.</p>

<p>Following this the device shall forget the network and enter a non-joining
mode.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Set-Dev-EUI ::= OCTET STRING (SIZE(8))

Response-Set-Dev-EUI ::= NULL</code></pre></figure>

<h4 id="set-app-eui">
<a id="set-app-eui" class="anchor" href="#set-app-eui" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set-App-EUI</h4>

<p>Write App-EUI to non-volatile memory.</p>

<p>Following this the device shall forget the network and enter a non-joining
mode.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Set-App-EUI ::= OCTET STRING (SIZE(8))

Response-Set-App-EUI- ::= NULL</code></pre></figure>

<h4 id="set-app-key">
<a id="set-app-key" class="anchor" href="#set-app-key" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set-App-Key</h4>

<p>Write App-Key to non-volatile memory.</p>

<p>Following this the device shall forget the network and enter a non-joining
mode.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Set-App-Key ::= OCTET STRING (SIZE(16))

Response-Set-App-Key ::= NULL</code></pre></figure>

<h4 id="get-dev-eui">
<a id="get-dev-eui" class="anchor" href="#get-dev-eui" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get-Dev-EUI</h4>

<p>Return the Dev-EUI.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Get-Dev-EUI ::= NULL

Response-Get-Dev-EUI ::= OCTET STRING (SIZE(8))</code></pre></figure>

<h4 id="get-app-eui">
<a id="get-app-eui" class="anchor" href="#get-app-eui" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get-App-EUI</h4>

<p>Return the App-EUI.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Get-App-EUI ::= NULL

Response-Get-App-EUI ::= OCTET STRING (SIZE(8))</code></pre></figure>

<h4 id="get-encrypted-app-key">
<a id="get-encrypted-app-key" class="anchor" href="#get-encrypted-app-key" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get-Encrypted-App-Key</h4>

<p>Return the result of performing AES-128 encryption of a zeroed block using the App-Key.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Get-Encrypted-App-Key ::= NULL

Response-Get-Encrypted-App-Key ::= OCTET STRING (SIZE(16))</code></pre></figure>

<h4 id="join-network">
<a id="join-network" class="anchor" href="#join-network" aria-hidden="true"><span class="octicon octicon-link"></span></a>Join-Network</h4>

<p>Device shall forget the network and enter a joining mode.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Join ::= NULL

Response-Join ::= NULL</code></pre></figure>

<h4 id="forget-network">
<a id="forget-network" class="anchor" href="#forget-network" aria-hidden="true"><span class="octicon octicon-link"></span></a>Forget-Network</h4>

<p>Device shall forget the network and enter a non-joining mode.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Forget ::= NULL

Response-Forget ::= NULL</code></pre></figure>

<h4 id="set-log-severity-level">
<a id="set-log-severity-level" class="anchor" href="#set-log-severity-level" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set-Log-Severity-Level</h4>

<p>Set the severity level for log messages pushed by Log-Message alert in accordance
with <a href="https://tools.ietf.org/html/rfc5424">RFC 5424</a>.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Set-Log-Severity-Level ::= INTEGER (0..255)

Response-Set-Log-Severity-Level ::= NULL</code></pre></figure>

<h4 id="get-vbat-and-ambient">
<a id="get-vbat-and-ambient" class="anchor" href="#get-vbat-and-ambient" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get-VBAT-And-Ambient</h4>

<p>Return the battery voltage and ambient temperature.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Get-Vbat-And-Ambient ::= NULL

Response-Get-Vbat-And-Ambient ::= SEQUENCE
{
    vbat INTEGER (0..65535),
    ambient INTEGER (0..65535)
}</code></pre></figure>

<h4 id="get-counter">
<a id="get-counter" class="anchor" href="#get-counter" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get-Counter</h4>

<p>Return a counter register.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Get-Counter ::= SEQUENCE
{
    index INTEGER (0..255)
}

Response-Get-Counter ::= CHOICE
{
    success                 INTEGER (0..4294967295),
    index-out-of-range      NULL    
}</code></pre></figure>

<h4 id="clear-counter">
<a id="clear-counter" class="anchor" href="#clear-counter" aria-hidden="true"><span class="octicon octicon-link"></span></a>Clear-Counter</h4>

<p>Zero a counter register.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Clear-Counter ::= SEQUENCE
{
    index INTEGER (0..255)
}

Response-Clear-Counter ::= CHOICE
{
    success                 NULL,
    index-out-of-range      NULL    
}</code></pre></figure>

<h4 id="set-pull">
<a id="set-pull" class="anchor" href="#set-pull" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set-Pull</h4>

<p>Set a pull-resistor.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Set-Pull ::= SEQUENCE
{
    index   INTEGER (0..255),
    setting ENUMERATED {
    
        pull-up,
        pull-down    
    }
}

Response-Set-Pull ::= CHOICE
{
    success                 NULL,
    index-out-of-range      NULL,
    setting-out-of-range    NULL    
}</code></pre></figure>

<h4 id="set-filter">
<a id="set-filter" class="anchor" href="#set-filter" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set-Filter</h4>

<p>Set an input filter.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Set-Filter ::= SEQUENCE
{
    index   INTEGER (0..255),
    setting ENUMERATED {
    
        none
    }
}

Response-Set-Filter ::= CHOICE
{
    success                 NULL,
    index-out-of-range      NULL,
    setting-out-of-range    NULL    
}</code></pre></figure>

<h4 id="goto-boot">
<a id="goto-boot" class="anchor" href="#goto-boot" aria-hidden="true"><span class="octicon octicon-link"></span></a>Goto-Boot</h4>

<p>Put device into bootloader mode.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Goto-Boot ::= NULL

Response-Goto-Boot ::= NULL</code></pre></figure>

<h4 id="goto-app">
<a id="goto-app" class="anchor" href="#goto-app" aria-hidden="true"><span class="octicon octicon-link"></span></a>Goto-App</h4>

<p>Put device into application mode.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Goto-App ::= NULL

Response-Goto-App ::= NULL</code></pre></figure>

<h4 id="boot-or-app">
<a id="boot-or-app" class="anchor" href="#boot-or-app" aria-hidden="true"><span class="octicon octicon-link"></span></a>Boot-Or-App</h4>

<p>Indicate whether device is in bootloader or application mode.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Boot-Or-App ::= NULL

Response-Boot-Or-App ::= ENUMERATED { boot (0), app (1) }</code></pre></figure>

<h4 id="get-boot-version">
<a id="get-boot-version" class="anchor" href="#get-boot-version" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get-Boot-Version</h4>

<p>Get bootloader version string.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Get-Boot-Version ::= NULL

Response-Get-Boot-Version ::= VisibleString</code></pre></figure>

<h4 id="get-app-version">
<a id="get-app-version" class="anchor" href="#get-app-version" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get-App-Version</h4>

<p>Get application version string.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Get-App-Version ::= NULL

Response-Get-App-Version ::= VisibleString</code></pre></figure>

<h4 id="restart">
<a id="restart" class="anchor" href="#restart" aria-hidden="true"><span class="octicon octicon-link"></span></a>Restart</h4>

<p>User request to restart the device.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Restart ::= NULL

Response-Restart ::= NULL</code></pre></figure>

<h4 id="get-device-name">
<a id="get-device-name" class="anchor" href="#get-device-name" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get-Device-Name</h4>

<p>Get the unique device name string.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Get-Device-Name ::= NULL

Response-Get-Device-Name ::= VisibleString (SIZE(0..36))</code></pre></figure>

<h4 id="set-device-name">
<a id="set-device-name" class="anchor" href="#set-device-name" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set-Device-Name</h4>

<p>Set the unique device name string.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Command-Set-Device-Name ::= VisibleString (SIZE(0..36))

Response-Set-Device-Name ::= CHOICE 
{
    success,
    too-long
}</code></pre></figure>

<h3 id="alerts">
<a id="alerts" class="anchor" href="#alerts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Alerts</h3>

<p>Alerts are constructed as a sequence of a Alert-Header
followed by an alert specific argument</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Alert-Header ::= [2] SEQUENCE 
{
    a-id    INTEGER (0..65535)
}</code></pre></figure>

<table>
  <thead>
    <tr>
      <th>a-id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td><a href="#unknown-message">Unknown-Message</a></td>
    </tr>
    <tr>
      <td>0x0001</td>
      <td><a href="#unknown-command">Unknown-Command</a></td>
    </tr>
    <tr>
      <td>0x0002</td>
      <td><a href="#invalid-command-argument">Invalid-Command-Argument</a></td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td><a href="#log">Log</a></td>
    </tr>
  </tbody>
</table>

<p>Alert arguments are encoded according to <a href="https://www.itu.int/rec/T-REC-X.696/en">Octet Encoding Rules X.696</a>.</p>

<h4 id="unknown-message">
<a id="unknown-message" class="anchor" href="#unknown-message" aria-hidden="true"><span class="octicon octicon-link"></span></a>Unknown-Message</h4>

<p>Pushed by device which has received a series of bytes which do
not match any expected patterns.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Alert-Unkown-Message ::= NULL</code></pre></figure>

<h4 id="unknown-command">
<a id="unknown-command" class="anchor" href="#unknown-command" aria-hidden="true"><span class="octicon octicon-link"></span></a>Unknown-Command</h4>

<p>Pushed by a device which has decoded an unimplemented c-id.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Alert-Unknown-Command ::= SEQUENCE
{
    token INTEGER (0..255),
    c-id  INTEGER (0..65535)
}</code></pre></figure>

<h4 id="invalid-command-argument">
<a id="invalid-command-argument" class="anchor" href="#invalid-command-argument" aria-hidden="true"><span class="octicon octicon-link"></span></a>Invalid-Command-Argument</h4>

<p>Pushed by a device which has decoded an invalid c-id specific argument.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Alert-Invalid-Command-Argument ::= SEQUENCE 
{
    token INTEGER (0..255),
    c-id  INTEGER (0..65535)
}</code></pre></figure>

<h4 id="log">
<a id="log" class="anchor" href="#log" aria-hidden="true"><span class="octicon octicon-link"></span></a>Log</h4>

<p>Used to push logging messages to a client depending on the severity level
set by <a href="#set-log-severity-level">Set-Log-Severity-Level</a> command.</p>

<figure class="highlight"><pre><code class="language-asn1" data-lang="asn1">Alert-Log ::= SEQUENCE
{
    level   INTEGER (0..255),
    message VisibleString
}</code></pre></figure>

<h2 id="hardware-revisions">
<a id="hardware-revisions" class="anchor" href="#hardware-revisions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hardware Revisions</h2>

<h3 id="040">
<a id="040" class="anchor" href="#040" aria-hidden="true"><span class="octicon octicon-link"></span></a>0.4.0</h3>

<p>Third revision. Changes from last revision include:</p>

<ul>
  <li>clamp diodes and TVS surge protection added to UART level converter</li>
  <li>via reinforced mounting holes with optional chassis ground</li>
  <li>optional external button header</li>
  <li>simplified input circuit with TVS diode for surge protection</li>
  <li>four inputs (up from two) each with configurable pull up/down resistors</li>
  <li>keepout underneath radio module</li>
  <li>0805 packages replaced with 0603</li>
  <li>larger pitch 6 way SWD header</li>
</ul>

<p><img src="/assets/third_pass_model.png" alt="3d model" class="center-image"></p>

<p><img src="/assets/third_pass_model_back.png" alt="3d model" class="center-image"></p>

<h3 id="020">
<a id="020" class="anchor" href="#020" aria-hidden="true"><span class="octicon octicon-link"></span></a>0.2.0</h3>

<p>Second revision. Changes from the last revision include:</p>

<ul>
  <li>U.FL replaced with dual SMA/U.FL footprint</li>
  <li>removed DIO4 and DIO5 routing</li>
  <li>using single inverter for UART transmit line</li>
  <li>removed reset button</li>
  <li>using larger footprints for easy soldering</li>
  <li>enlarged M2 mounting holes to M3</li>
</ul>

<p>This revision has been used to develop the firmware. A number of 
problems were discovered during the course of development:</p>

<ul>
  <li>There should be a top-layer keepout underneath U3; trace isolation is currently dependent on soldermask integrity</li>
  <li>Pin assignments don’t take into account external interrupt multiplexing of the STM32</li>
  <li>The design needs speed up capacitors on the level converter</li>
  <li>ADC result is measured against VDD and not the reference (therefore the VDD resistor divider is not required)</li>
</ul>

<p><img src="/assets/second_pass_model.png" alt="3d model" class="center-image"></p>

<p><img src="/assets/lpc_0.2.0.jpg" alt="assembled board" class="center-image"></p>

<h3 id="011">
<a id="011" class="anchor" href="#011" aria-hidden="true"><span class="octicon octicon-link"></span></a>0.1.1</h3>

<p>This was the first revision. A number of mistakes were made, namely:</p>

<ul>
  <li>There was copper (and a via!) underneath the U.FL connector</li>
  <li>Pin assignments mean STM32L051K8 cannot be swapped for the new lower cost STM32L010K8</li>
  <li>The UART level converter power consumption could be improved by using the 
MCU UART signal invert feature</li>
  <li>The reset switch is redundant</li>
  <li>Standard footprints are too small for easy hand soldering</li>
  <li>Double row storage capacitors are difficult to solder by hand</li>
</ul>

<p>This revision was swiftly replaced with <a href="#020">0.2.0</a>.</p>

<p><img src="/assets/first_pass_model.png" alt="3d model" class="center-image"></p>

<p><img src="/assets/first_pass_assembled.jpg" alt="assembled board" class="center-image"></p>

  </div>

  

  <a class="u-url" href="/lpc" hidden></a>
</article>

      </div>
    </main>

    <footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          
            
            <li><a class="u-email" href="mailto:contact@cjh.id.au">contact@cjh.id.au</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/cjhdev"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">cjhdev</span></a></li>
  
  <li><a href="https://www.linkedin.com/in/cameronisanengineer"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">cameronisanengineer</span></a></li>
  
  
  
  
  
  
</ul>

      </div>

    </div>

  </div>

</footer>


  </body>

</html>
